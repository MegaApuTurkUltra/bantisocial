<style>
pre {
  max-height: 100px;
  overflow-y: scroll;
  padding: 5px;
  background-color: #CCC;
  color: #111;
}
</style>

<div id="messages"></div>
<form id="form" action="">
  <input id="chat-input" autofocus>
  <button>Send</button>
</form>
<p>
  <button id="set-userid">Set new user ID</button>
  Your user ID: <span id="user-id">(no ID)</span>
</p>
<p>
  <button id="gen-key">Generate OpenPGP key</button>
  <button id="load-key">Decrypt/load key</button>
  <button id="save-key">Save key</button>
  <button id="publish-key">Publish public key</button>
</p>

<script src="/socket.io/socket.io.js"></script>
<script src="lib/openpgp.min.js"></script>
<script>
const apiPost = function(path, dataObj) {
  return fetch(path, {
    method: 'post',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(dataObj)
  })
}

const main = async function() {
  const socket = io()

  let userID

  const userIDSpan = document.getElementById('user-id')
  const setUserID = function(newUserID) {
    userID = newUserID
    while (userIDSpan.firstChild) userIDSpan.firstChild.remove()
    document.getElementById('user-id').appendChild(document.createTextNode(userID))
  }

  setUserID('user' + Math.trunc(1000000 * Math.random()))

  let privateKey, publicKey, privateKeyObj
  let publicKeyDictionary = {}

  if ('privateKey' in localStorage && 'publicKey' in localStorage) {
    privateKey = localStorage.privateKey
    publicKey = localStorage.publicKey
    console.log('loaded key pair from local storage')
  }

  document.getElementById('gen-key').addEventListener('click', async () => {
    const name = prompt('What name would you like to assign to your key?')
    const email = prompt('What email address would you like to assign to your key?')
    const passphrase = prompt('What passphrase would you like to use with your key?')

    if (!(name && email && passphrase)) {
      alert('Please specify a name, email address, and passphrase.')
      return
    }

    console.log('generating key..')

    const key = await openpgp.generateKey({
      numBits: 4096,
      passphrase,
      userIds: [
        {name, email}
      ]
    })

    publicKey = key.publicKeyArmored
    privateKey = key.privateKeyArmored

    console.log('generated key')
  })

  document.getElementById('load-key').addEventListener('click', () => {
    if (!(privateKey && publicKey)) {
      console.error('cannot load key - none is available')
      return
    }

    const passphrase = prompt('What is the key\'s passphrase?')

    privateKeyObj = openpgp.key.readArmored(privateKey).keys[0]
    privateKeyObj.decrypt(passphrase)

    console.log('loaded private key')
  })

  document.getElementById('save-key').addEventListener('click', () => {
    if (!(privateKey && publicKey)) {
      console.error('cannot save key - none is available')
      return
    }

    localStorage.publicKey = publicKey
    localStorage.privateKey = privateKey
  })

  document.getElementById('publish-key').addEventListener('click', async () => {
    if (!(privateKey && publicKey)) {
      console.error('cannot publish key - none is available')
      return
    }

    await apiPost('/api/release-public-key', {
      key: publicKey, userID
    })
  })

  document.getElementById('set-userid').addEventListener('click', () => {
    const newUserID = prompt('What do you want your new user ID to be?')

    if (newUserID) {
      setUserID(newUserID)
    }
  })

  const chatInput = document.getElementById('chat-input')
  const form = document.getElementById('form')
  form.addEventListener('submit', async evt => {
    evt.preventDefault()

    const text = chatInput.value
    chatInput.value = ''

    if (text.trim().length === 0) {
      return
    }

    let signature

    if (publicKey && privateKeyObj) {
      const cleartext = await openpgp.sign({
        data: text,
        privateKeys: privateKeyObj
      })

      signature = cleartext.data

      console.log('signed message')
    }

    await apiPost('/api/send-message', {
      text,
      signature,
      userID
    })
  })

  const messagesContainer = document.getElementById('messages')

  socket.on('received chat message', async msg => {
    if (typeof msg !== 'object') {
      console.warn('received non-object message:', msg)
      return
    }

    const { text, signature, author } = msg.message

    if (!text || !userID) {
      return
    }

    const el = document.createElement('div')

    el.appendChild(document.createTextNode(`${author}: ${text}`))

    if (signature) {
      if (author in publicKeyDictionary === false) {
        el.appendChild(document.createTextNode(' (Signed, but this user is not in your public key dictionary)'))
      } else {
        const verified = await openpgp.verify({
          message: openpgp.cleartext.readArmored(signature),
          publicKeys: openpgp.key.readArmored(publicKeyDictionary[author]).keys
        })

        if (verified.signatures[0].valid) {
          el.appendChild(document.createTextNode(' (Verified)'))
        } else {
          el.appendChild(document.createTextNode(' (FORGED? Signature data provided, but sign did not match)'))
        }
      }
    } else {
      el.appendChild(document.createTextNode(' (No signature data)'))
    }

    messagesContainer.appendChild(el)
  })

  socket.on('released public key', async msg => {
    if (typeof msg !== 'object') {
      return
    }

    if ('key' in msg === false) {
      return
    }

    if ('userID' in msg === false) {
      return
    }

    const el = document.createElement('div')
    el.appendChild(document.createTextNode(msg.userID))
    el.appendChild(document.createTextNode(' has released a public key!'))

    const pre = document.createElement('pre')
    pre.appendChild(document.createTextNode(msg.key))
    el.appendChild(pre)

    const accept = document.createElement('button')
    accept.appendChild(document.createTextNode('Accept'))
    el.appendChild(accept)

    const ignore = document.createElement('button')
    ignore.appendChild(document.createTextNode('Ignore'))
    el.appendChild(ignore)

    messagesContainer.appendChild(el)

    accept.addEventListener('click', () => {
      el.remove()

      // TODO: __proto__, prototype, bad stuff
      publicKeyDictionary[msg.userID] = msg.key
    })

    ignore.addEventListener('click', () => {
      el.remove()
    })
  })
}

main()
  .catch(error => console.error(error))
</script>
